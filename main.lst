C51 COMPILER V8.02   MAIN                                                                  06/02/2013 20:47:35 PAGE 1   


C51 COMPILER V8.02, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE src\main.c BROWSE DEBUG OBJECTEXTEND PRINT(.\main.lst) OBJECT(main.obj)

line level    source

   1          #include"STC11.h"
   2          #include "time.h"
   3          //-----------------------
   4          #define TIME_OUTPUT 12000
   5          #define LOW 1
   6          #define OUT_2MIN_DEF  output[6]
   7          //-----------------------
   8          sbit low_high_input_select = P1^5;
   9          //-----------------------
  10          //输入信号
  11          sbit IN1 = P3^2;
  12          sbit IN2 = P3^3;
  13          sbit IN3 = P3^4;
  14          sbit IN4 = P3^5; 
  15          sbit IN5 = P3^7;
  16          sbit IN6 = P3^0;
  17          //-----------------------
  18          sbit OUT1 = P1^0;
  19          sbit OUT2 = P1^1;
  20          sbit OUT3 = P1^2;
  21          sbit OUT4 = P1^3;
  22          sbit OUT5 = P1^4;
  23          sbit OUT6 = P3^1;
  24          //----------------------
  25          sbit OUT_2MIN = P1^6;//2分钟后输出
  26          sbit CLEAR_ALARM = P1^7;//报警解除输入
  27          //-----------------------
  28          unsigned char input[7] = {0,0,0,0,0,0,0};//输入缓冲
  29          unsigned char output[7] = {0,0,0,0,0,0,0};//输出缓冲
  30          unsigned char input_valid[5] = {0,0,0,0,0};
  31          unsigned long count_10ms[6]={0,0,0,0,0,0};
  32          unsigned char flg_2min_come[6]={0,0,0,0,0,0};
  33          //-----------------------
  34          unsigned char min2_output = 0;
  35          unsigned char flg_10ms = 0;
  36          unsigned char flg_10ms2 = 0;
  37          unsigned char output_state = 1;
  38          unsigned char output_level = 1;
  39          unsigned int output_state_high_count = 0;
  40          unsigned int output_state_low_count = 0;
  41          unsigned char output_pulse_count  = 0;
  42          //-----------------------
  43          void init_port(void);
  44          void init_timer0(void);
  45          void system_handle(void);
  46          void io_handle(void);
  47          void output_2min_handle(void);
  48          void wait_get_input(void);
  49          //-----------------------
  50          void main(void)
  51          {
  52   1         init_port();//初始化io口
  53   1         
  54   1         init_timer0();
  55   1         
C51 COMPILER V8.02   MAIN                                                                  06/02/2013 20:47:35 PAGE 2   

  56   1         EA =1;
  57   1      
  58   1         wait_get_input();//等待获取输入信号
  59   1      
  60   1         while(1)
  61   1          {
  62   2                       system_handle();
  63   2                       output_2min_handle();
  64   2          }
  65   1      }
  66          
  67          void init_port(void)
  68          {
  69   1              P1M0 = 0x40;
  70   1              P1M1 = 0;
  71   1              OUT1 = 0;
  72   1              OUT2 = 0;
  73   1              OUT3 = 0;
  74   1              OUT4 = 0;
  75   1              OUT5 = 0;
  76   1              OUT6 = 0;
  77   1              OUT_2MIN = 0;
  78   1      }
  79          
  80          void timer0_int() interrupt 1
  81          {
  82   1        //12M 10MS
  83   1        TH0 = 0xD8;
  84   1        TL0 = 0xF0;
  85   1        flg_10ms = 1;
  86   1        flg_10ms2 = 1;
  87   1        //schedule_timer();
  88   1        //time_count_30min();
  89   1        io_handle();
  90   1       
  91   1       }
  92          void init_timer0(void)
  93          {
  94   1              TMOD |= 0X01;
  95   1              TH0 = 0xD8;
  96   1              TL0 = 0xF0;
  97   1              ET0 = 1;
  98   1              TR0 = 1;
  99   1      }
 100          
 101          //信号处理程序
 102          void system_handle(void)
 103          {                                                                                       
 104   1              static unsigned char system_state = 1;
 105   1      
 106   1              static unsigned char  sub_system_state[5]={1,1,1,1,1};
 107   1              
 108   1              unsigned char i =0;
 109   1              
 110   1              if(flg_10ms)
 111   1              {
 112   2                      flg_10ms = 0;//须在此清零
 113   2                      switch(system_state)
 114   2                      {
 115   3                              case 1:
 116   3                              //P2 = system_state;
 117   3                                      //控制输出端输出
C51 COMPILER V8.02   MAIN                                                                  06/02/2013 20:47:35 PAGE 3   

 118   3                                      if((input[0]==LOW)||(input[1]==LOW)||(input[2]==LOW)||(input[3]==LOW)||(input[4]==LOW))
 119   3                                      {       
 120   4                                              output[5] = 1;
 121   4                                      }
 122   3                                      else
 123   3                                      {
 124   4                                              output[5] = 0;
 125   4                                      }
 126   3                                      //2min延时
 127   3                                      for(i=0;i<5;i++)
 128   3                                      {
 129   4                                              if(input[i]==LOW)
 130   4                                              {
 131   5                                                      count_10ms[i]++;
 132   5                                                      if(count_10ms[i]==TIME_OUTPUT)
 133   5                                                      {
 134   6                                                              flg_2min_come[i] = 1;
 135   6                                                              count_10ms[i] =0;
 136   6                                                      }       
 137   5                                              }
 138   4                                              else
 139   4                                              {       
 140   5                                                      count_10ms[i] = 0;
 141   5                                                      if(flg_2min_come[i])
 142   5                                                      {
 143   6                                                         flg_2min_come[i] = 0;
 144   6                                                      }
 145   5                                              }
 146   4                                      }
 147   3      
 148   3                                      if(flg_2min_come[0]==1||flg_2min_come[1]==1||flg_2min_come[2]==1||flg_2min_come[3]==1||flg_2min_come[4
             -]==1)
 149   3                                      {
 150   4                                              min2_output = 1;
 151   4                                      }
 152   3                                      else
 153   3                                      {
 154   4                                              min2_output = 0;        
 155   4                                      }
 156   3                              break;
 157   3                              case 2:
 158   3                              break;
 159   3                              case 3:
 160   3                              //P2 = system_state;
 161   3                              for(i=0;i<5;i++)
 162   3                              {
 163   4                                      switch(sub_system_state[i])
 164   4                                      {
 165   5                                              case 1:
 166   5                                                      if(input[i]==LOW)//没有释放
 167   5                                                      {
 168   6                                                              input_valid[i] = 0;             
 169   6                                                      }
 170   5                                                      else
 171   5                                                      {
 172   6                                                              input_valid[i] = 0;     
 173   6                                                              sub_system_state[i] = 2;
 174   6                                                      }
 175   5                                              break;
 176   5                                              case 2:
 177   5                                                      if(input[i]==LOW)
 178   5                                                      {
C51 COMPILER V8.02   MAIN                                                                  06/02/2013 20:47:35 PAGE 4   

 179   6                                                              input_valid[i] = 1;     
 180   6                                                      }
 181   5                                                      else
 182   5                                                      {
 183   6                                                              input_valid[i] = 0;
 184   6                                                      }
 185   5                                                         //enable_output[i] = 1;
 186   5                                              break;
 187   5                                              default:
 188   5                                                      sub_system_state[i] = 1;
 189   5                                              break;
 190   5                                      }                       
 191   4                              }
 192   3      
 193   3                              //控制输出端输出
 194   3                              if((input_valid[0]==1)||(input_valid[1]==1)||(input_valid[2]==1)||(input_valid[3]==1)||(input_valid[4]=
             -=1))
 195   3                              {       
 196   4                                      output[5] = 1;
 197   4                              }
 198   3                              else
 199   3                              {
 200   4                                      output[5] = 0;
 201   4                              }
 202   3                              //2min延时
 203   3                              for(i=0;i<5;i++)
 204   3                              {
 205   4                                      if(input_valid[i]==1)
 206   4                                      {
 207   5                                              count_10ms[i]++;
 208   5                                              if(count_10ms[i]==TIME_OUTPUT)
 209   5                                              {
 210   6                                                      flg_2min_come[i] = 1;
 211   6                                                      count_10ms[i] =0;
 212   6                                              }
 213   5                                                              
 214   5                                      }
 215   4                                      else
 216   4                                      {       
 217   5                                              count_10ms[i] = 0;
 218   5                              
 219   5                                              if(flg_2min_come[i])
 220   5                                              {
 221   6                                                 flg_2min_come[i] = 0;
 222   6                                              }
 223   5                                      }
 224   4                              }
 225   3      
 226   3                              if(flg_2min_come[0]==1||flg_2min_come[1]==1||flg_2min_come[2]==1||flg_2min_come[3]==1||flg_2min_come[4]
             -==1)
 227   3                              {
 228   4                                      min2_output = 1;
 229   4                              }
 230   3                              else
 231   3                              {
 232   4                                      min2_output = 0;        
 233   4                              }
 234   3                              break;
 235   3                              
 236   3                              default:
 237   3                                      system_state = 1; 
 238   3                              break;
C51 COMPILER V8.02   MAIN                                                                  06/02/2013 20:47:35 PAGE 5   

 239   3                      }
 240   2                      
 241   2              }
 242   1              //消音按键按下
 243   1              if(input[6]==0)
 244   1              {
 245   2                      for(i=0;i<6;i++)
 246   2                      {
 247   3                              sub_system_state[i] = 1;
 248   3                              output[5] = 0;//关闭输出
 249   3                              count_10ms[i] =0;       
 250   3                              flg_2min_come[i] = 0;
 251   3                              min2_output = 0;//关两分钟输出
 252   3                              system_state = 3;
 253   3                      }
 254   2                      
 255   2              }
 256   1      }
 257          
 258          void io_handle(void)
 259          {
 260   1          static unsigned char low_count[7];
 261   1          static unsigned char high_count[7];
 262   1          //-----------------------------
 263   1          IN1 = 1;    
 264   1          if(IN1==1)
 265   1          {
 266   2             low_count[0] = 0;
 267   2             high_count[0]++;
 268   2             if(high_count[0]==10)
 269   2              {
 270   3                 input[0] = 1; 
 271   3                 high_count[0] = 0;
 272   3              }
 273   2          }
 274   1          else
 275   1          {
 276   2             high_count[0] = 0;
 277   2             low_count[0]++;
 278   2             if(low_count[0]==10)
 279   2              {
 280   3                 input[0] = 0; 
 281   3                 low_count[0] = 0;
 282   3              }        
 283   2          }
 284   1          //-----------------------------   
 285   1          IN2 = 1;    
 286   1          if(IN2==1)
 287   1          {
 288   2             low_count[1] = 0;
 289   2             high_count[1]++;
 290   2             if(high_count[1]==10)
 291   2              {
 292   3                 input[1] = 1; 
 293   3                 high_count[1] = 0;
 294   3              }
 295   2          }
 296   1          else
 297   1          {
 298   2             high_count[1] = 0;
 299   2             low_count[1]++;
 300   2             if(low_count[1]==10)
C51 COMPILER V8.02   MAIN                                                                  06/02/2013 20:47:35 PAGE 6   

 301   2              {
 302   3                 input[1] = 0; 
 303   3                 low_count[1] = 0;
 304   3              }        
 305   2          }
 306   1          //-----------------------------  
 307   1          IN3 = 1;    
 308   1          if(IN3==1)
 309   1          {
 310   2             low_count[2] = 0;
 311   2             high_count[2]++;
 312   2             if(high_count[2]==10)
 313   2              {
 314   3                 input[2] = 1; 
 315   3                 high_count[2] = 0;
 316   3              }
 317   2          }
 318   1          else
 319   1          {
 320   2             high_count[2] = 0;
 321   2             low_count[2]++;
 322   2             if(low_count[2]==10)
 323   2              {
 324   3                 input[2] = 0; 
 325   3                 low_count[2] = 0;
 326   3              }        
 327   2          }
 328   1          //-----------------------------  
 329   1          IN4= 1;    
 330   1          if(IN4==1)
 331   1          {
 332   2             low_count[3] = 0;
 333   2             high_count[3]++;
 334   2             if(high_count[3]==10)
 335   2              {
 336   3                 input[3] = 1; 
 337   3                 high_count[3] = 0;
 338   3              }
 339   2          }
 340   1          else
 341   1          {
 342   2             high_count[3] = 0;
 343   2             low_count[3]++;
 344   2             if(low_count[3]==10)
 345   2              {
 346   3                 input[3] = 0; 
 347   3                 low_count[3] = 0;
 348   3              }        
 349   2          }
 350   1          //-----------------------------
 351   1          IN5 = 1;    
 352   1          if(IN5==1)
 353   1          {
 354   2             low_count[4] = 0;
 355   2             high_count[4]++;
 356   2             if(high_count[4]==10)
 357   2              {
 358   3                 input[4] = 1; 
 359   3                 high_count[4] = 0;
 360   3              }
 361   2          }
 362   1          else
C51 COMPILER V8.02   MAIN                                                                  06/02/2013 20:47:35 PAGE 7   

 363   1          {
 364   2             high_count[4] = 0;
 365   2             low_count[4]++;
 366   2             if(low_count[4]==10)
 367   2              {
 368   3                 input[4] = 0; 
 369   3                 low_count[4] = 0;
 370   3              }        
 371   2          }
 372   1          //-----------------------------
 373   1      
 374   1          IN6 = 1;    
 375   1          if(IN6==1)
 376   1          {
 377   2             low_count[5] = 0;
 378   2             high_count[5]++;
 379   2             if(high_count[5]==10)
 380   2              {
 381   3                 input[5] = 1; 
 382   3                 high_count[5] = 0;
 383   3              }
 384   2          }
 385   1          else
 386   1          {
 387   2             high_count[5] = 0;
 388   2             low_count[5]++;
 389   2             if(low_count[5]==10)
 390   2              {
 391   3                 input[5] = 0; 
 392   3                 low_count[5] = 0;
 393   3              }        
 394   2          }
 395   1          //-----------------------------
 396   1      
 397   1              CLEAR_ALARM = 1;
 398   1              if(CLEAR_ALARM==1)
 399   1          {
 400   2             low_count[6] = 0;
 401   2             high_count[6]++;
 402   2             if(high_count[6]==10)
 403   2              {
 404   3                 input[6] = 1; 
 405   3                 high_count[6] = 0;
 406   3              }
 407   2          }
 408   1          else
 409   1          {
 410   2             high_count[6] = 0;
 411   2             low_count[6]++;
 412   2             if(low_count[6]==10)
 413   2              {
 414   3                 input[6] = 0; 
 415   3                 low_count[6] = 0;
 416   3              }        
 417   2          }
 418   1          //-----------------------------      
 419   1         //  OUT1 = (bit)output[0];
 420   1          // OUT2 = (bit)output[1];
 421   1           //OUT3 = (bit)output[2];
 422   1           //OUT4 = (bit)output[3];
 423   1           //OUT5 = (bit)output[4];
 424   1               OUT6 = (bit)output[5];
C51 COMPILER V8.02   MAIN                                                                  06/02/2013 20:47:35 PAGE 8   

 425   1               OUT_2MIN = (bit)output[6];
 426   1      }
 427          
 428          void output_2min_handle(void)
 429          {
 430   1                       if(flg_10ms2)
 431   1                       {
 432   2                               flg_10ms2 = 0;
 433   2      
 434   2                              if(min2_output)
 435   2                              {
 436   3                                      switch(output_state)
 437   3                                      {
 438   4                                              case 1://前5个脉冲输出
 439   4                                                      if(output_level)//输出电平高低
 440   4                                                      {
 441   5                                                              OUT_2MIN_DEF = 1;
 442   5                                                              output_state_high_count++;
 443   5                                                              if(output_state_high_count==200)
 444   5                                                              {
 445   6                                                                      output_state_high_count = 0;
 446   6                                                                      output_level = 0;
 447   6                                                              }
 448   5                                                      }
 449   4                                                      else//(output_level==0)
 450   4                                                      {
 451   5                                                              OUT_2MIN_DEF = 0;
 452   5                                                              output_state_low_count++;
 453   5                                                              if(output_state_low_count==100)
 454   5                                                              {
 455   6                                                                      output_state_low_count = 0;
 456   6                                                                      output_level = 1;
 457   6                                                                      
 458   6                                                                      output_pulse_count++;
 459   6                                                                      if(output_pulse_count==5)
 460   6                                                                      {
 461   7                                                                              output_state = 2;
 462   7                                                                              output_pulse_count = 0;
 463   7                                                                      }                                       
 464   6                                                              }
 465   5      
 466   5                                                      }
 467   4                                              break;
 468   4                                              case 2:
 469   4                                                      if(output_level)//输出电平高
 470   4                                                      {
 471   5                                                              OUT_2MIN_DEF = 1;
 472   5                                                              output_state_high_count++;
 473   5                                                              if(output_state_high_count==500)
 474   5                                                              {
 475   6                                                                      output_state_high_count = 0;
 476   6                                                                      output_level = 0;
 477   6                                                              }
 478   5                                                      }
 479   4                                                      else//(output_level==0)
 480   4                                                      {
 481   5                                                              OUT_2MIN_DEF = 0;
 482   5                                                              output_state_low_count++;
 483   5                                                              if(output_state_low_count==200)
 484   5                                                              {
 485   6                                                                      output_state_low_count = 0;
 486   6                                                                      output_level = 1;
C51 COMPILER V8.02   MAIN                                                                  06/02/2013 20:47:35 PAGE 9   

 487   6                                                                      
 488   6                                                                      output_state = 1;
 489   6                                                              }
 490   5                                                      }               
 491   4                                              break;
 492   4                                              
 493   4                                      }                       
 494   3                              }
 495   2                              else
 496   2                              {
 497   3                                         OUT_2MIN_DEF = 0;
 498   3                              }
 499   2                       }
 500   1      }
 501          void wait_get_input(void)
 502          {
 503   1              static unsigned char wait_time = 20;
 504   1              
 505   1              while(wait_time)
 506   1              {
 507   2                      if(flg_10ms)
 508   2                      {
 509   3                              flg_10ms = 0;
 510   3                              wait_time--;
 511   3                      }
 512   2              }
 513   1      
 514   1      }
 515          
 516          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1161    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     80       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
