C51 COMPILER V8.02   MAIN                                                                  05/28/2013 21:46:10 PAGE 1   


C51 COMPILER V8.02, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE src\main.c BROWSE DEBUG OBJECTEXTEND PRINT(.\main.lst) OBJECT(main.obj)

line level    source

   1          /*
   2          整理描述 ：
   3              当输入端输入一个下降沿 低电平保持时间为2秒，
   4              就会在对应输出端出现一个2秒的高电平，然后该输出端转到低电平。
   5              若输入端低电平保持时间超过30MIN，
   6              对应端再输出一次2秒的高电平，周而复始。
   7          */
   8          
   9          #include"STC11.h"
  10          #include "time.h"
  11          
  12          #define HIGH_CON 1
  13          #define LOW_CON 0
  14          #define TIME_OUTPUT 12000
  15          #define OUTPUT_FOLLOW 0
  16          //输入信号
  17          sbit IN1 = P3^2;
  18          sbit IN2 = P3^3;
  19          sbit IN3 = P3^4;
  20          sbit IN4 = P3^5;  
  21          sbit IN5 = P3^7;
  22          
  23          sbit IN6 = P3^0;
  24          sbit OUT6 = P3^1;
  25          
  26          sbit low_high_input_select = P1^5;
  27          
  28          //输出信号 控制指示灯
  29          sbit OUT1 = P1^0;
  30          sbit OUT2 = P1^1;
  31          sbit OUT3 = P1^2;
  32          sbit OUT4 = P1^3;
  33          sbit OUT5 = P1^4;
  34          
  35          sbit OUT_2MIN = P1^6;//2分钟后输出
  36          
  37          sbit CLEAR_ALARM = P1^7;//报警解除输入
  38          
  39          unsigned char input[7] = {1,1,1,1,1,1,1};//输入缓冲
  40          unsigned char output[7] = {0,0,0,0,0,0,0};//输出缓冲
  41          unsigned long sec_count[6] = {0,0,0,0,0,0};
  42          
  43          
  44          unsigned char sub_system_state[6]={1,1,1,1,1,1};
  45          
  46          unsigned char system_state=1;
  47          
  48          unsigned char clear_alarm_state = 1;
  49          
  50          unsigned char flg_timer_running = 0;//初始状态定时器没有在运行
  51          //unsigned char alarm_clear = 1;
  52          
  53          unsigned char low_high_input_select_flg = 0;
  54          
  55          void init_timer0(void);
C51 COMPILER V8.02   MAIN                                                                  05/28/2013 21:46:10 PAGE 2   

  56          void init_port(void);
  57          void system_handle(void);
  58          void output_delay(unsigned char parm);
  59          void delayms(unsigned int delay_time);
  60          void io_handle(void);
  61          void delay_ouput(unsigned char parm);
  62          unsigned char timeout_flg[5];
  63          unsigned char en_soft_timer[5];
  64          
  65          void main(void)
  66          {
  67   1         init_port();//初始化io口
  68   1         
  69   1         init_timer0();
  70   1      
  71   1         low_high_input_select = 1;
  72   1         if(low_high_input_select)
  73   1         {
  74   2                      delayms(6000);
  75   2                      if(low_high_input_select)
  76   2                      {
  77   3                              low_high_input_select_flg = 1;
  78   3                              input[0] = 0;
  79   3                              input[1] = 0;
  80   3                              input[2] = 0;
  81   3                              input[3] = 0;
  82   3                              input[4] = 0;
  83   3                              input[5] = 0;
  84   3                              //input[6] = 0;                 
  85   3                              
  86   3                      }               
  87   2         }
  88   1         else
  89   1         {
  90   2                      low_high_input_select_flg = 0;  
  91   2                              input[0] = 1;
  92   2                              input[1] = 1;
  93   2                              input[2] = 1;
  94   2                              input[3] = 1;
  95   2                              input[4] = 1;
  96   2                              input[5] = 1;
  97   2                              input[6] = 1;   
  98   2         }
  99   1         
 100   1         EA =1;
 101   1         while(1)
 102   1          {
 103   2               system_handle();
 104   2          }
 105   1      }
 106          
 107          //短暂延时函数
 108          void delayms(unsigned int delay_time)
 109          {
 110   1          while(delay_time--);
 111   1      }
 112          
 113          void init_port(void)
 114          {
 115   1              P1M0 = 0x40;
 116   1              P1M1 = 0;
 117   1      
C51 COMPILER V8.02   MAIN                                                                  05/28/2013 21:46:10 PAGE 3   

 118   1              OUT1 = 0;
 119   1              OUT2 = 0;
 120   1              OUT3 = 0;
 121   1              OUT4 = 0;
 122   1              OUT5 = 0;
 123   1              OUT6 = 0;
 124   1              OUT_2MIN = 0;
 125   1              //sign_timer(12000,delay_ouput,1);
 126   1              //while(1);
 127   1      
 128   1      }
 129          
 130          void timer0_int() interrupt 1
 131          {
 132   1        //12M 10MS
 133   1        TH0 = 0xD8;
 134   1      
 135   1        TL0 = 0xF0;
 136   1        
 137   1        schedule_timer();
 138   1       // time_count_30min();
 139   1        io_handle();
 140   1       
 141   1       }
 142          void init_timer0(void)
 143          {
 144   1              TMOD |= 0X01;
 145   1              TH0 = 0xD8;
 146   1              TL0 = 0xF0;
 147   1              ET0 = 1;
 148   1              TR0 = 1;
 149   1      }
 150          
 151          //信号处理程序
 152          void system_handle(void)
 153          {
 154   1      
 155   1      //      static unsigned char alarm_key_pressed = 0;
 156   1              unsigned char i;
 157   1              if(low_high_input_select_flg==1)
 158   1                      {
 159   2                              switch(system_state)
 160   2                              {
 161   3                                      case 1:
 162   3                                              for(i=0;i<6;i++)
 163   3                                              {
 164   4                                                      if((input[i]==HIGH_CON))
 165   4                                                      {
 166   5                                                              output[i] = 1;
 167   5                                                              if(flg_timer_running==0)
 168   5                                                              {
 169   6                                                                      sign_timer(TIME_OUTPUT,delay_ouput,1);
 170   6                                                                      flg_timer_running = 1;  
 171   6                                                              }
 172   5              
 173   5                                                      }
 174   4                                                      else
 175   4                                                      {
 176   5                                                              #if OUTPUT_FOLLOW
                                                                              output[i] = 0;
                                                                      #endif
 179   5                                                      }
C51 COMPILER V8.02   MAIN                                                                  05/28/2013 21:46:10 PAGE 4   

 180   4                                              }       
 181   3                                      break;
 182   3                                      case 2://do nothing 
 183   3                                      break;
 184   3                                      case 3:
 185   3                                              i = 0;
 186   3                                              for(i=0;i<6;i++)
 187   3                                              {
 188   4                                                      switch(sub_system_state[i])
 189   4                                                      {
 190   5                                                              case 1://如果信号仍然有效
 191   5                                                                      if(input[i]==HIGH_CON)
 192   5                                                                      {
 193   6                                                                              //waiting
 194   6                                                                      }
 195   5                                                                      else
 196   5                                                                      {
 197   6                                                                              sub_system_state[i] = 2;
 198   6                                                                      }
 199   5                                                              break;
 200   5                                                              case 2:
 201   5                                                                      if(input[i]==HIGH_CON)//信号有效
 202   5                                                                      {
 203   6                                                                              sub_system_state[i] = 1;
 204   6                                                                              output[i] = 1;
 205   6                                                                              if(flg_timer_running==0)
 206   6                                                                              {
 207   7                                                                                      sign_timer(TIME_OUTPUT,delay_ouput,1);
 208   7                                                                                      flg_timer_running = 1;  
 209   7                                                                              }                       
 210   6                                                                      }
 211   5                                                                      else
 212   5                                                                      {
 213   6                                                                              //do nothing
 214   6                                                                      }
 215   5                                                              break;
 216   5                                                              default:
 217   5                                                              break;
 218   5                                                      }       
 219   4                                              }       
 220   3                                      break;
 221   3                                      default:
 222   3                                      break;
 223   3                              }       
 224   2                      }
 225   1              else 
 226   1                      {
 227   2                              switch(system_state)
 228   2                              {
 229   3                                      case 1:
 230   3                                              for(i=0;i<6;i++)
 231   3                                              {
 232   4                                                      if((input[i]==LOW_CON))
 233   4                                                      {
 234   5                                                              output[i] = 1;
 235   5                                                              if(flg_timer_running==0)
 236   5                                                              {
 237   6                                                                      sign_timer(TIME_OUTPUT,delay_ouput,1);
 238   6                                                                      flg_timer_running = 1;  
 239   6                                                              }
 240   5                                                      }
 241   4                                                      else
C51 COMPILER V8.02   MAIN                                                                  05/28/2013 21:46:10 PAGE 5   

 242   4                                                      {
 243   5                                                      #if OUTPUT_FOLLOW
                                                                      output[i] = 0;
                                                              #endif
 246   5                                                              
 247   5                                                      }
 248   4                                              }       
 249   3                                      break;
 250   3                                      case 2://do nothing 
 251   3                                      break;
 252   3                                      case 3:
 253   3                                              for(i=0;i<6;i++)
 254   3                                              {
 255   4                                                      switch(sub_system_state[i])
 256   4                                                      {
 257   5                                                              case 1://如果信号仍然有效
 258   5                                                                      if(input[i]==LOW_CON)
 259   5                                                                      {
 260   6                                                                              //waiting
 261   6                                                                      }
 262   5                                                                      else
 263   5                                                                      {
 264   6                                                                              sub_system_state[i] = 2;
 265   6                                                                      }
 266   5                                                              break;
 267   5                                                              case 2:
 268   5                                                                      if(input[i]==LOW_CON)//信号有效
 269   5                                                                      {
 270   6                                                                              sub_system_state[i] = 1;
 271   6                                                                              output[i] = 1;
 272   6                                                                              if(flg_timer_running==0)
 273   6                                                                              {
 274   7                                                                                      sign_timer(TIME_OUTPUT,delay_ouput,1);
 275   7                                                                                      flg_timer_running = 1;  
 276   7                                                                              }                       
 277   6                                                                      }
 278   5                                                                      else
 279   5                                                                      {
 280   6                                                                              //do nothing
 281   6                                                                      }
 282   5                                                              break;
 283   5                                                              default:
 284   5                                                              break;
 285   5                                                      }       
 286   4                                              }       
 287   3                                      break;
 288   3                                      default:
 289   3                                      break;
 290   3                              }
 291   2                      }
 292   1                      switch(clear_alarm_state)
 293   1                              {
 294   2                                      case 1:
 295   2                                              if(input[6]==0)//解除报警按钮按下
 296   2                                              {
 297   3                                              //-----------------------------
 298   3                                              //      system_state = 2;
 299   3                                              //-----------------------------
 300   3                                                      clear_alarm_state = 2;
 301   3                                                      //解除所有报警
 302   3                                                      for(i=0;i<6;i++)
 303   3                                                      {
C51 COMPILER V8.02   MAIN                                                                  05/28/2013 21:46:10 PAGE 6   

 304   4                                                              sub_system_state[i] = 1;//都在第一步
 305   4                                                              output[i] = 0;
 306   4                                                      }
 307   3                                                      output[6] = 0;//2min output     
 308   3                                                      stop_all_timer();
 309   3                                              }       
 310   2                                      break;
 311   2                                      case 2:
 312   2                                              if(input[6]==1)//按键释放
 313   2                                              {
 314   3                                                      //-----------------------------
 315   3                                              //      system_state = 3;
 316   3                                                              //-----------------------------
 317   3                                                      clear_alarm_state = 1;
 318   3                                                      flg_timer_running = 0;
 319   3                                              }               
 320   2                                      break;  
 321   2                                      default:
 322   2                                              clear_alarm_state = 1;
 323   2                                      break;
 324   2                              }
 325   1      
 326   1      }
 327          
 328          void io_handle(void)
 329          {
 330   1          static unsigned char low_count[7];
 331   1          static unsigned char high_count[7];
 332   1          //-----------------------------
 333   1          IN1 = 1;    
 334   1          if(IN1==1)
 335   1          {
 336   2             low_count[0] = 0;
 337   2             high_count[0]++;
 338   2             if(high_count[0]==10)
 339   2              {
 340   3                 input[0] = 1; 
 341   3                 high_count[0] = 0;
 342   3              }
 343   2          }
 344   1          else
 345   1          {
 346   2             high_count[0] = 0;
 347   2             low_count[0]++;
 348   2             if(low_count[0]==10)
 349   2              {
 350   3                 input[0] = 0; 
 351   3                 low_count[0] = 0;
 352   3              }        
 353   2          }
 354   1          //-----------------------------   
 355   1          IN2 = 1;    
 356   1          if(IN2==1)
 357   1          {
 358   2             low_count[1] = 0;
 359   2             high_count[1]++;
 360   2             if(high_count[1]==10)
 361   2              {
 362   3                 input[1] = 1; 
 363   3                 high_count[1] = 0;
 364   3              }
 365   2          }
C51 COMPILER V8.02   MAIN                                                                  05/28/2013 21:46:10 PAGE 7   

 366   1          else
 367   1          {
 368   2             high_count[1] = 0;
 369   2             low_count[1]++;
 370   2             if(low_count[1]==10)
 371   2              {
 372   3                 input[1] = 0; 
 373   3                 low_count[1] = 0;
 374   3              }        
 375   2          }
 376   1          //-----------------------------  
 377   1          IN3 = 1;    
 378   1          if(IN3==1)
 379   1          {
 380   2             low_count[2] = 0;
 381   2             high_count[2]++;
 382   2             if(high_count[2]==10)
 383   2              {
 384   3                 input[2] = 1; 
 385   3                 high_count[2] = 0;
 386   3              }
 387   2          }
 388   1          else
 389   1          {
 390   2             high_count[2] = 0;
 391   2             low_count[2]++;
 392   2             if(low_count[2]==10)
 393   2              {
 394   3                 input[2] = 0; 
 395   3                 low_count[2] = 0;
 396   3              }        
 397   2          }
 398   1          //-----------------------------  
 399   1          IN4= 1;    
 400   1          if(IN4==1)
 401   1          {
 402   2             low_count[3] = 0;
 403   2             high_count[3]++;
 404   2             if(high_count[3]==10)
 405   2              {
 406   3                 input[3] = 1; 
 407   3                 high_count[3] = 0;
 408   3              }
 409   2          }
 410   1          else
 411   1          {
 412   2             high_count[3] = 0;
 413   2             low_count[3]++;
 414   2             if(low_count[3]==10)
 415   2              {
 416   3                 input[3] = 0; 
 417   3                 low_count[3] = 0;
 418   3              }        
 419   2          }
 420   1          //-----------------------------
 421   1          IN5 = 1;    
 422   1          if(IN5==1)
 423   1          {
 424   2             low_count[4] = 0;
 425   2             high_count[4]++;
 426   2             if(high_count[4]==10)
 427   2              {
C51 COMPILER V8.02   MAIN                                                                  05/28/2013 21:46:10 PAGE 8   

 428   3                 input[4] = 1; 
 429   3                 high_count[4] = 0;
 430   3              }
 431   2          }
 432   1          else
 433   1          {
 434   2             high_count[4] = 0;
 435   2             low_count[4]++;
 436   2             if(low_count[4]==10)
 437   2              {
 438   3                 input[4] = 0; 
 439   3                 low_count[4] = 0;
 440   3              }        
 441   2          }
 442   1          //-----------------------------
 443   1      
 444   1          IN6 = 1;    
 445   1          if(IN6==1)
 446   1          {
 447   2             low_count[5] = 0;
 448   2             high_count[5]++;
 449   2             if(high_count[5]==10)
 450   2              {
 451   3                 input[5] = 1; 
 452   3                 high_count[5] = 0;
 453   3              }
 454   2          }
 455   1          else
 456   1          {
 457   2             high_count[5] = 0;
 458   2             low_count[5]++;
 459   2             if(low_count[5]==10)
 460   2              {
 461   3                 input[5] = 0; 
 462   3                 low_count[5] = 0;
 463   3              }        
 464   2          }
 465   1          //-----------------------------
 466   1      
 467   1              CLEAR_ALARM = 1;
 468   1              if(CLEAR_ALARM==1)
 469   1          {
 470   2             low_count[6] = 0;
 471   2             high_count[6]++;
 472   2             if(high_count[6]==10)
 473   2              {
 474   3                 input[6] = 1; 
 475   3                 high_count[6] = 0;
 476   3              }
 477   2          }
 478   1          else
 479   1          {
 480   2             high_count[6] = 0;
 481   2             low_count[6]++;
 482   2             if(low_count[6]==10)
 483   2              {
 484   3                 input[6] = 0; 
 485   3                 low_count[6] = 0;
 486   3              }        
 487   2          }
 488   1          //-----------------------------      
 489   1           OUT1 = (bit)output[0];
C51 COMPILER V8.02   MAIN                                                                  05/28/2013 21:46:10 PAGE 9   

 490   1           OUT2 = (bit)output[1];
 491   1           OUT3 = (bit)output[2];
 492   1           OUT4 = (bit)output[3];
 493   1           OUT5 = (bit)output[4];
 494   1               OUT6 = (bit)output[5];
 495   1               OUT_2MIN = (bit)output[6];
 496   1      }
 497          
 498          void delay_ouput(unsigned char parm)
 499          {
 500   1              parm = parm;
 501   1          output[6] = 1;
 502   1              flg_timer_running = 0;  
 503   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    885    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     72       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
