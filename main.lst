C51 COMPILER V8.02   MAIN                                                                  05/29/2013 20:52:24 PAGE 1   


C51 COMPILER V8.02, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE src\main.c BROWSE DEBUG OBJECTEXTEND PRINT(.\main.lst) OBJECT(main.obj)

line level    source

   1          /*
   2          整理描述 ：
   3              当输入端输入一个下降沿 低电平保持时间为2秒，
   4              就会在对应输出端出现一个2秒的高电平，然后该输出端转到低电平。
   5              若输入端低电平保持时间超过30MIN，
   6              对应端再输出一次2秒的高电平，周而复始。
   7          */
   8          
   9          #include"STC11.h"
  10          #include "time.h"
  11          
  12          #define HIGH_CON 1
  13          #define LOW_CON 0
  14          #define TIME_OUTPUT 12000
  15          #define OUTPUT_FOLLOW 1
  16          
  17          #define HIGH 1
  18          #define LOW 0
  19          
  20          #define min2_output output[6]
  21          //输入信号
  22          sbit IN1 = P3^2;
  23          sbit IN2 = P3^3;
  24          sbit IN3 = P3^4;
  25          sbit IN4 = P3^5;  
  26          sbit IN5 = P3^7;
  27          
  28          sbit IN6 = P3^0;
  29          sbit OUT6 = P3^1;
  30          
  31          sbit low_high_input_select = P1^5;
  32          
  33          //输出信号 控制指示灯
  34          sbit OUT1 = P1^0;
  35          sbit OUT2 = P1^1;
  36          sbit OUT3 = P1^2;
  37          sbit OUT4 = P1^3;
  38          sbit OUT5 = P1^4;
  39          
  40          sbit OUT_2MIN = P1^6;//2分钟后输出
  41          
  42          sbit CLEAR_ALARM = P1^7;//报警解除输入
  43          
  44          unsigned char input[7] = {1,1,1,1,1,1,1};//输入缓冲
  45          unsigned char output[7] = {0,0,0,0,0,0,0};//输出缓冲
  46          
  47          unsigned char flg_10ms = 0;
  48          unsigned long count_10ms[6]={0,0,0,0,0,0};
  49          unsigned char flg_2min_come[6]={0,0,0,0,0,0};
  50          
  51          
  52          void init_timer0(void);
  53          void init_port(void);
  54          void system_handle(void);
  55          void io_handle(void);
C51 COMPILER V8.02   MAIN                                                                  05/29/2013 20:52:24 PAGE 2   

  56          
  57          unsigned char input_valid[5] = {0,0,0,0,0};
  58          
  59          void main(void)
  60          {
  61   1         init_port();//初始化io口
  62   1         
  63   1         init_timer0();
  64   1         
  65   1         EA =1;
  66   1         while(1)
  67   1          {
  68   2               system_handle();
  69   2          }
  70   1      }
  71          
  72          
  73          void init_port(void)
  74          {
  75   1              P1M0 = 0x40;
  76   1              P1M1 = 0;
  77   1      
  78   1              OUT1 = 0;
  79   1              OUT2 = 0;
  80   1              OUT3 = 0;
  81   1              OUT4 = 0;
  82   1              OUT5 = 0;
  83   1              OUT6 = 0;
  84   1              OUT_2MIN = 0;
  85   1              //sign_timer(12000,delay_ouput,1);
  86   1              //while(1);
  87   1      
  88   1      }
  89          
  90          void timer0_int() interrupt 1
  91          {
  92   1        //12M 10MS
  93   1        TH0 = 0xD8;
  94   1      
  95   1        TL0 = 0xF0;
  96   1        flg_10ms = 1;
  97   1        //schedule_timer();
  98   1       // time_count_30min();
  99   1        io_handle();
 100   1       
 101   1       }
 102          void init_timer0(void)
 103          {
 104   1              TMOD |= 0X01;
 105   1              TH0 = 0xD8;
 106   1              TL0 = 0xF0;
 107   1              ET0 = 1;
 108   1              TR0 = 1;
 109   1      }
 110          
 111          //信号处理程序
 112          void system_handle(void)
 113          {
 114   1              static unsigned char system_state = 1;
 115   1      
 116   1              static unsigned char  sub_system_state[5]={1,1,1,1,1};
 117   1              unsigned char i =0;
C51 COMPILER V8.02   MAIN                                                                  05/29/2013 20:52:24 PAGE 3   

 118   1              switch(system_state)
 119   1              {
 120   2                      case 1:
 121   2                              //输入 输出 对应通道处理
 122   2                              if(flg_10ms)//10ms置位一次
 123   2                              {
 124   3                                      flg_10ms = 0;//须在此清零
 125   3                      
 126   3                                      //控制输出端输出
 127   3                                      if((input[0]==LOW)||(input[1]==LOW)||(input[2]==LOW)||(input[3]==LOW)||(input[4]==LOW))
 128   3                                      {       
 129   4                                              output[5] = 1;
 130   4                                      }
 131   3                                      else
 132   3                                      {
 133   4                                              output[5] = 0;
 134   4                                      }
 135   3                                      //2min延时
 136   3                                      for(i=0;i<5;i++)
 137   3                                      {
 138   4                                              if(input[i]==LOW)
 139   4                                              {
 140   5                                                      count_10ms[i]++;
 141   5                                                      if(count_10ms[i]==TIME_OUTPUT)
 142   5                                                      {
 143   6                                                              flg_2min_come[i] = 1;
 144   6                                                              count_10ms[i] =0;
 145   6                                                      }
 146   5                                                      
 147   5                                              }
 148   4                                              else
 149   4                                              {       
 150   5                                                      count_10ms[i] = 0;
 151   5                      
 152   5                                                      if(flg_2min_come[i])
 153   5                                                      {
 154   6                                                         flg_2min_come[i] = 0;
 155   6                                                      }
 156   5                                              }
 157   4                                      }
 158   3                      
 159   3                      
 160   3                                      if(flg_2min_come[0]==1||flg_2min_come[1]==1||flg_2min_come[2]==1||flg_2min_come[3]==1||flg_2min_come[4
             -]==1)
 161   3                                      {
 162   4                                              min2_output = 1;
 163   4                                      }
 164   3                                      else
 165   3                                      {
 166   4                                              min2_output = 0;        
 167   4                                      }
 168   3                              
 169   3                              }
 170   2                      break;
 171   2                      case 2:
 172   2                      break;
 173   2                      case 3:
 174   2                      for(i=0;i<5;i++)
 175   2                      {
 176   3                              switch(sub_system_state[i])
 177   3                              {
 178   4                                      case 1:
C51 COMPILER V8.02   MAIN                                                                  05/29/2013 20:52:24 PAGE 4   

 179   4                                              if(input[i]==LOW)//没有释放
 180   4                                              {
 181   5                                                      input_valid[i] = 0;             
 182   5                                              }
 183   4                                              else
 184   4                                              {
 185   5                                                      input_valid[i] = 0;     
 186   5                                                      sub_system_state[i] = 2;
 187   5                                              }
 188   4                                      break;
 189   4                                      case 2:
 190   4                                              if(input[i]==LOW)
 191   4                                              {
 192   5                                                      input_valid[i] = 1;     
 193   5                                              }
 194   4                                              else
 195   4                                              {
 196   5                                                      input_valid[i] = 0;
 197   5                                              }
 198   4                                                 //enable_output[i] = 1;
 199   4                                      break;
 200   4                                      default:
 201   4                                              sub_system_state[i] = 1;
 202   4                                      break;
 203   4                              }                       
 204   3                      }
 205   2      
 206   2      
 207   2                              //输入 输出 对应通道处理
 208   2                              if(flg_10ms)//10ms置位一次
 209   2                              {
 210   3                                      flg_10ms = 0;//须在此清零
 211   3                      
 212   3                                      //控制输出端输出
 213   3                                      if((input_valid[0]==1)||(input_valid[1]==1)||(input_valid[2]==1)||(input_valid[3]==1)||(input_valid[4]
             -==1))
 214   3                                      {       
 215   4                                              output[5] = 1;
 216   4                                      }
 217   3                                      else
 218   3                                      {
 219   4                                              output[5] = 0;
 220   4                                      }
 221   3                                      //2min延时
 222   3                                      for(i=0;i<5;i++)
 223   3                                      {
 224   4                                              if(input_valid[i]==1)
 225   4                                              {
 226   5                                                      count_10ms[i]++;
 227   5                                                      if(count_10ms[i]==TIME_OUTPUT)
 228   5                                                      {
 229   6                                                              flg_2min_come[i] = 1;
 230   6                                                              count_10ms[i] =0;
 231   6                                                      }
 232   5                                                      
 233   5                                              }
 234   4                                              else
 235   4                                              {       
 236   5                                                      count_10ms[i] = 0;
 237   5                      
 238   5                                                      if(flg_2min_come[i])
 239   5                                                      {
C51 COMPILER V8.02   MAIN                                                                  05/29/2013 20:52:24 PAGE 5   

 240   6                                                         flg_2min_come[i] = 0;
 241   6                                                      }
 242   5                                              }
 243   4                                      }
 244   3                      
 245   3                      
 246   3                                      if(flg_2min_come[0]==1||flg_2min_come[1]==1||flg_2min_come[2]==1||flg_2min_come[3]==1||flg_2min_come[4
             -]==1)
 247   3                                      {
 248   4                                              min2_output = 1;
 249   4                                      }
 250   3                                      else
 251   3                                      {
 252   4                                              min2_output = 0;        
 253   4                                      }
 254   3                              
 255   3                              }
 256   2      
 257   2                      break;
 258   2              }
 259   1      
 260   1      
 261   1              //消音按键按下
 262   1              if(input[6]==0)
 263   1              {
 264   2                      for(i=0;i<6;i++)
 265   2                      {
 266   3                              sub_system_state[i] = 1;
 267   3                              output[5] = 0;//关闭输出
 268   3                              count_10ms[i] =0;       
 269   3                              flg_2min_come[i] = 0;
 270   3                              min2_output = 0;//关两分钟输出
 271   3                              system_state = 3;
 272   3                      }
 273   2                      
 274   2              }
 275   1      }
 276          
 277          void io_handle(void)
 278          {
 279   1          static unsigned char low_count[7];
 280   1          static unsigned char high_count[7];
 281   1          //-----------------------------
 282   1          IN1 = 1;    
 283   1          if(IN1==1)
 284   1          {
 285   2             low_count[0] = 0;
 286   2             high_count[0]++;
 287   2             if(high_count[0]==10)
 288   2              {
 289   3                 input[0] = 1; 
 290   3                 high_count[0] = 0;
 291   3              }
 292   2          }
 293   1          else
 294   1          {
 295   2             high_count[0] = 0;
 296   2             low_count[0]++;
 297   2             if(low_count[0]==10)
 298   2              {
 299   3                 input[0] = 0; 
 300   3                 low_count[0] = 0;
C51 COMPILER V8.02   MAIN                                                                  05/29/2013 20:52:24 PAGE 6   

 301   3              }        
 302   2          }
 303   1          //-----------------------------   
 304   1          IN2 = 1;    
 305   1          if(IN2==1)
 306   1          {
 307   2             low_count[1] = 0;
 308   2             high_count[1]++;
 309   2             if(high_count[1]==10)
 310   2              {
 311   3                 input[1] = 1; 
 312   3                 high_count[1] = 0;
 313   3              }
 314   2          }
 315   1          else
 316   1          {
 317   2             high_count[1] = 0;
 318   2             low_count[1]++;
 319   2             if(low_count[1]==10)
 320   2              {
 321   3                 input[1] = 0; 
 322   3                 low_count[1] = 0;
 323   3              }        
 324   2          }
 325   1          //-----------------------------  
 326   1          IN3 = 1;    
 327   1          if(IN3==1)
 328   1          {
 329   2             low_count[2] = 0;
 330   2             high_count[2]++;
 331   2             if(high_count[2]==10)
 332   2              {
 333   3                 input[2] = 1; 
 334   3                 high_count[2] = 0;
 335   3              }
 336   2          }
 337   1          else
 338   1          {
 339   2             high_count[2] = 0;
 340   2             low_count[2]++;
 341   2             if(low_count[2]==10)
 342   2              {
 343   3                 input[2] = 0; 
 344   3                 low_count[2] = 0;
 345   3              }        
 346   2          }
 347   1          //-----------------------------  
 348   1          IN4= 1;    
 349   1          if(IN4==1)
 350   1          {
 351   2             low_count[3] = 0;
 352   2             high_count[3]++;
 353   2             if(high_count[3]==10)
 354   2              {
 355   3                 input[3] = 1; 
 356   3                 high_count[3] = 0;
 357   3              }
 358   2          }
 359   1          else
 360   1          {
 361   2             high_count[3] = 0;
 362   2             low_count[3]++;
C51 COMPILER V8.02   MAIN                                                                  05/29/2013 20:52:24 PAGE 7   

 363   2             if(low_count[3]==10)
 364   2              {
 365   3                 input[3] = 0; 
 366   3                 low_count[3] = 0;
 367   3              }        
 368   2          }
 369   1          //-----------------------------
 370   1          IN5 = 1;    
 371   1          if(IN5==1)
 372   1          {
 373   2             low_count[4] = 0;
 374   2             high_count[4]++;
 375   2             if(high_count[4]==10)
 376   2              {
 377   3                 input[4] = 1; 
 378   3                 high_count[4] = 0;
 379   3              }
 380   2          }
 381   1          else
 382   1          {
 383   2             high_count[4] = 0;
 384   2             low_count[4]++;
 385   2             if(low_count[4]==10)
 386   2              {
 387   3                 input[4] = 0; 
 388   3                 low_count[4] = 0;
 389   3              }        
 390   2          }
 391   1          //-----------------------------
 392   1      
 393   1          IN6 = 1;    
 394   1          if(IN6==1)
 395   1          {
 396   2             low_count[5] = 0;
 397   2             high_count[5]++;
 398   2             if(high_count[5]==10)
 399   2              {
 400   3                 input[5] = 1; 
 401   3                 high_count[5] = 0;
 402   3              }
 403   2          }
 404   1          else
 405   1          {
 406   2             high_count[5] = 0;
 407   2             low_count[5]++;
 408   2             if(low_count[5]==10)
 409   2              {
 410   3                 input[5] = 0; 
 411   3                 low_count[5] = 0;
 412   3              }        
 413   2          }
 414   1          //-----------------------------
 415   1      
 416   1              CLEAR_ALARM = 1;
 417   1              if(CLEAR_ALARM==1)
 418   1          {
 419   2             low_count[6] = 0;
 420   2             high_count[6]++;
 421   2             if(high_count[6]==10)
 422   2              {
 423   3                 input[6] = 1; 
 424   3                 high_count[6] = 0;
C51 COMPILER V8.02   MAIN                                                                  05/29/2013 20:52:24 PAGE 8   

 425   3              }
 426   2          }
 427   1          else
 428   1          {
 429   2             high_count[6] = 0;
 430   2             low_count[6]++;
 431   2             if(low_count[6]==10)
 432   2              {
 433   3                 input[6] = 0; 
 434   3                 low_count[6] = 0;
 435   3              }        
 436   2          }
 437   1          //-----------------------------      
 438   1         //  OUT1 = (bit)output[0];
 439   1          // OUT2 = (bit)output[1];
 440   1           //OUT3 = (bit)output[2];
 441   1           //OUT4 = (bit)output[3];
 442   1           //OUT5 = (bit)output[4];
 443   1               OUT6 = (bit)output[5];
 444   1               OUT_2MIN = (bit)output[6];
 445   1      }
 446          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    972    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     70       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
